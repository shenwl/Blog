# 打包分析 & preloading & prefetching

## 打包分析
1. 使用[webpack/analyse](https://github.com/webpack/analyse)进行分析
  - 使用，打包并生成分析文件: `webpack --profile --json > stats.json`
  - 将stats.json上传[在线分析工具](http://webpack.github.com/analyse)，查看图形化分析

2. 使用其它分析工具
  - https://webpack.js.org/guides/code-splitting#bundle-analysis
  - webpack-bundle-analyzer


## webpack希望我们如何写代码
1. code split的局限
  - 把lodash等库做code split，有缓存，第二次访问速度很快
  - 但是对第一次访问的速度并没有加强
  - 我们希望第一次访问的速度就是最快的


2. 交互代码模块异步加载, 提升代码利用率
  - 代码示例
    ```javascript
    // handleClick.js
    export default function handleClick() {
      const el = document.createElement('div');
      el.innerHTML = 'dynamic import';
      document.body.appendChild(el);
    }

    // index.js
    document.addEventListener('click', () => {
      import('./handleClick.js').then(({ default: handleClick }) => {
        handleClick();
      });
    });
    ```
  - chrome查看利用率：console -> cmd + shift + p -> 输入coverage

  - 将未利用的部分设置为异步加载，首屏加载时间会大大缩短

3. 交互部分点击之后再去加载模块，交互响应速度会比较慢
  - preloading & prefetching去解决


## preloading & prefetching解决异步加载模块影响交互响应问题
1. 解决异步模块交互响应比较慢问题的原理
  - 首屏加载完后，页面带宽已经释放，可以利用空闲时间先把响应交互的模块下载下来

  - 既满足首页核心代码加载非常快的需求，又满足交互快速响应需求（比如登录模态框异步模块）

2. 如何做
  - 使用webpack打包特性，利用magic comment实现prefetch
    ```javascript
    // ...
    import(/* webpackPrefetch: true */ 'LoginModal');
    ```

  - preload写法
    ```javascript
    // ...
    import(/* webpackLoad: true */ 'LoginModal');
    ```

  - prefetch和preload的区别
    * prefetch会等你页面加载完成后，贷款有空闲，再去加载异步模块

    * preload是和主业务文件一起去加载

